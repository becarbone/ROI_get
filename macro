var total, sourcedir, sourcelist, ROIdir, numChan, finChan;
var channels, chanArray, title, i, n, repeat, newTitle, measure; 
waitForUser("This macro needs a few folders: \n-the original images \n-an empty one for the each channel \n-an empty one for the ROI files");
total = 0
sourcedir = getDirectory("Choose folder of images");
sourcelist = getFileList(sourcedir);
ROIdir = getDirectory("Choose folder to save the ROI in");
filedir = getDirectory("Choose folder for ROI .zip files");
ROIarrayzip = newArray("ROI,Area","");
Dialog.create("Channel Info");
		choices = newArray("rectangle","polygon");
		Dialog.addChoice("What shape ROI?",choices,"polygon");
		Dialog.addNumber("How many channels?",0,0,1,"channel/s");
	Dialog.show();
	numChan = Dialog.getNumber();
	choice = Dialog.getChoice();
	Dialog.create("what colors\nare they");
		channels = newArray("Cyan","Blue","Green","Red");
		for(n=0;n<numChan;n++){
			Dialog.addChoice("color",channels,channels[n]);
		}
	Dialog.show();
	chanArray = newArray();
	ROIArray = newArray();
	for(n=0;n<numChan;n++) {
		chanArray = Array.concat(chanArray,Dialog.getChoice());
		File.makeDirectory(ROIdir+chanArray[n]);
		ROIpath = getDirectory("Choose folder for the " + chanArray[n]+" channel");
		ROIArray = Array.concat(ROIArray, ROIpath);
	}

for(p = 0; p<sourcelist.length;p++) {
	open(sourcedir+sourcelist[p]);
	run("Properties...", "channels="+numChan+" slices=1 frames=1 unit=micron pixel_width=0.1801990 pixel_height=0.1801990 voxel_depth=0.2967900");
	title = getTitle();
	for (i = nImages; i > 0; i--) {
		selectImage(i);
		run("Channels Tool...");
		//creates a loop for multiple ROI in one image
		Dialog.create("Repeat?");
			Dialog.addMessage("Do you have a new ROI in frame?");
			//if you answer "yes" in lowercase it will continue, if
			//anything else it will close the image and continue to the next one
			Dialog.addString("", "yes or no",40);
			Dialog.show();
		repeat = Dialog.getString();
		roiManager("reset");
		while (repeat == "yes") {
			run("Original Scale");			
			title = getTitle();
			//this is the function, see the bottom of the macro
			createROI();
			ROIArrayzip = Array.concat(ROIArrayzip,title + "," + measure);
			Dialog.create("Repeat?");
				Dialog.addMessage("Do you have a new ROI in frame?");
				Dialog.addString("", "yes or no",30);
				Dialog.show();
			repeat = Dialog.getString();
		}
		if(repeat != "yes") {
			roiManager("Save", filedir + title+"_ROI.zip");
			close();
		}
	}
}
Array.show(ROIArrayzip);
selectWindow("ROIArrayzip");
saveAs("Results", filedir+"ROI.csv")


function createROI()
	{
	setTool(choice);
	run("In [+]");
	run("In [+]");
	run("In [+]");
	title=getTitle();
	Dialog.create("Title");
		Dialog.addMessage("Rename for ROI number");
		Dialog.addString("", title,50);
		Dialog.show();
	newTitle = Dialog.getString();
	rename(newTitle);
	title=getTitle();
	selectWindow(title);
	waitForUser ("Select ROI then hit OK");
	roiManager("Add");
	run("Clear Results");
	run("Measure");
	measure = getResult("Area",0);
	
	selectWindow(title);
	c=0;
	for(l=0;l<numChan;l++) {	
		setSlice(l+1);
		run("Copy");
		run("Internal Clipboard");
		selectWindow("Clipboard");
		run(chanArray[c]);
		saveAs("Tiff", ROIArray[l]+title+"_"+chanArray[c]);
		close();
		c=c+1;
	}
	selectWindow(title);
	run("View 100%");
}
